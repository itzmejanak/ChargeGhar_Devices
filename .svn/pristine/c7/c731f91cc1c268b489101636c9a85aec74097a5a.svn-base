package com.demo.controller;

import com.aliyuncs.exceptions.ClientException;
import com.demo.aliyun.DeviceOnline;
import com.demo.aliyun.IotUtils;
import com.demo.aliyun.MnsUtils;
import com.demo.aliyun.RentboxUtils;
import com.demo.bean.DeviceInfo;
import com.demo.common.AppConfig;
import com.demo.common.HttpResult;
import com.demo.message.Powerbank;
import com.demo.message.ReceivePopupSN;
import com.demo.message.ReceiveUpload;
import com.demo.tools.ByteUtils;
import com.demo.tools.HttpServletUtils;
import com.demo.tools.SignUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.BoundValueOperations;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@ResponseBody
@Controller
public class ShowController {
    @Autowired
    AppConfig appConfig;

    @Autowired
    MnsUtils mnsUtils;

    @Autowired
    IotUtils iotUtils;

    @Autowired
    RentboxUtils rentboxUtils;

    @Autowired
    RedisTemplate redisTemplate;

    @RequestMapping("/show.html")
    public ModelAndView showHtml(@RequestParam String deviceName) throws ClientException {
        ModelAndView mv = new ModelAndView("/web/views/page/show");

        DeviceOnline deviceOnline = iotUtils.getDeviceStatus(appConfig.getProductKey(), deviceName);
        mv.addObject("deviceOnline", deviceOnline);
        mv.addObject("getTopic", "/" + appConfig.getProductKey() + "/" + deviceName + "/user/get");
        mv.addObject("updateTopic", "/" + appConfig.getProductKey() + "/" + deviceName + "/user/update");

        //MQTT CONNECT API
        String contextPath = HttpServletUtils.getRealContextpath();
        String url = (contextPath + "/api/iot/client/con?simUUID=&simMobile=&uuid=" + deviceName + "&deviceId=" + 0 + "&sign=");
        url += SignUtils.getSign(url);
        mv.addObject("connectUrl", url);

        //hardware version
        String key = "hardware:" + deviceName;
        BoundValueOperations boundValueOps = redisTemplate.boundValueOps(key);
        String hardware = (String) boundValueOps.get();
        mv.addObject("hardware", hardware);

        return mv;
    }

    @RequestMapping("/send")
    public HttpResult send(@RequestParam String deviceName, @RequestParam String data, HttpServletResponse response) throws ClientException {
        HttpResult httpResult = new HttpResult();
        try {
            String topic = "/" + appConfig.getProductKey() + "/" + deviceName + "/user/get";
            iotUtils.sendMsgAsync(appConfig.getProductKey(), topic, data, 1);
        }
        catch (Exception e){
            response.setStatus(HttpStatus.SC_INTERNAL_SERVER_ERROR);
            httpResult.setCode(response.getStatus());
            httpResult.setMsg(e.toString());
        }
        return httpResult;
    }

    @RequestMapping("/check")
    public HttpResult check(@RequestParam String deviceName, HttpServletResponse response) throws ClientException {
        HttpResult httpResult = new HttpResult();
        try {
            ReceiveUpload receiveUpload = rentboxUtils.check(deviceName);
            httpResult.setData(receiveUpload.getPowerbanks());
        }
        catch (Exception e){
            response.setStatus(HttpStatus.SC_INTERNAL_SERVER_ERROR);
            httpResult.setCode(response.getStatus());
            httpResult.setMsg(e.toString());
        }
        return httpResult;
    }

    @RequestMapping("/check_all")
    public HttpResult checkAll(@RequestParam String deviceName, HttpServletResponse response) throws ClientException {
        HttpResult httpResult = new HttpResult();
        try {
            ReceiveUpload receiveUpload = rentboxUtils.checkAll(deviceName);
            httpResult.setData(receiveUpload.getPowerbanks());
        }
        catch (Exception e){
            response.setStatus(HttpStatus.SC_INTERNAL_SERVER_ERROR);
            httpResult.setCode(response.getStatus());
            httpResult.setMsg(e.toString());
        }
        return httpResult;
    }

    @RequestMapping("/popup_random")
    public HttpResult checkAll(@RequestParam String deviceName, @RequestParam Integer minPower, HttpServletResponse response) throws ClientException {
        HttpResult httpResult = new HttpResult();
        try {
            ReceivePopupSN receivePopupSN = rentboxUtils.popupByRandom(deviceName, minPower);
            if(receivePopupSN.getStatus() != 0x01){
                throw new Exception("Popup Error:" + ByteUtils.to16Hexs(receivePopupSN.getBytes()));
            }
            httpResult.setData(receivePopupSN.getSnAsString());
        }
        catch (Exception e){
            response.setStatus(HttpStatus.SC_INTERNAL_SERVER_ERROR);
            httpResult.setCode(response.getStatus());
            httpResult.setMsg(e.toString());
        }
        return httpResult;
    }


}
