<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOT Device Management</title>
    <#include "/web/views/common/header.html" />
    <link rel="stylesheet" type="text/css" href="${_contextPath}/web/resource/css/index-dashboard.css">
</head>

<body>
    <div class="bg-animation"></div>

    <div id="vue1" style="display: flex; width: 100%; height: 100vh;">
        <#include "/web/views/common/sidebar.html" />

        <div class="main-content">
            <div class="credentials-bar header-card">
                <div class="credential-item">
                    <span class="credential-label">Broker</span>
                    <span class="credential-value">${mqttBroker}</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">Username</span>
                    <span class="credential-value">${mqttUsername}</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">Product Key</span>
                    <span class="credential-value">${data.productKey}</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">Connection</span>
                    <span class="credential-value">${mqtt}</span>
                </div>
            </div>

            <div class="content-area">
                <div class="action-buttons">
                    <button class="action-btn create" onclick="vue1.createDevice()">
                        <span>âž•</span> CREATE DEVICE
                    </button>
                    <a href="${_contextPath}/listen.html" target="_blank" class="action-btn">
                        <span>ðŸ“¡</span> MQTT LISTENER
                    </a>
                    <button class="action-btn admin" onclick="vue1.showAdminPanel()">
                        <span>ðŸ‘¥</span> ADMIN MANAGEMENT
                    </button>
                    <a href="${_contextPath}/version.html" target="_blank" class="action-btn">
                        <span>ðŸ”„</span> VERSION UPDATE
                    </a>
                    <a href="${_contextPath}/emqx/test/connection" target="_blank" class="action-btn">
                        <span>ðŸ§ª</span> TEST API
                    </a>
                </div>

                <div class="device-table-container">
                    <div class="table-header">
                        <div class="table-title">
                            <span>ðŸ“±</span> Connected Devices
                        </div>
                    </div>
                    <table id="table1" lay-filter="table1"></table>
                </div>
            </div>
        </div>

        <!-- Floating Logout Button -->
        <button class="floating-logout-btn" onclick="vue1.logout()" title="Logout">
            <span class="logout-icon">ðŸšª</span>
        </button>
    </div>

    <#include "/web/views/common/script.html" />

    <script type="text/html" id="tools">
        <div style="display: flex; gap: 6px; justify-content: center; padding: 4px;">
            <a class="layui-btn layui-btn-xs layui-bg-green" href="{{d.connectUrl}}" target="_blank" title="Connect API" style="padding: 5px 10px !important;">
                CONNECT
            </a>
            <a class="layui-btn layui-btn-xs" href="${_contextPath}/show.html?deviceName={{d.deviceName}}" target="_blank" title="Device Control" style="background: #4299e1 !important; border-color: #4299e1 !important; padding: 5px 10px !important;">
                CONTROL
            </a>
            <a class="layui-btn layui-btn-xs layui-bg-red" lay-event="delete" title="Delete Device" style="padding: 5px 10px !important;">
                DELETE
            </a>
        </div>
    </script>

    <script>
        var list = [];
        <#list deviceInfos as item>
            list.push({'deviceName': '${item.deviceName}', 'status' : '${item.deviceOnline}', 'connectUrl' : '${item.connectUrl}', 'hardware' : '${item.hardware}'});
        </#list>

        var vue1 = new Vue({
            el: '#vue1',
            data: {
                data: list
            },
            methods: {
                init: function () {
                    layui.table.render({
                        elem: '#table1',
                        height: 'full-280',
                        data: vue1.data,
                        limit: Number.MAX_SAFE_INTEGER,
                        page: true,
                        limits: [50, 100, 200, 500, 1000],
                        cols: [[
                            { type: 'numbers', width: 80, title: '#' },
                            { field: 'deviceName', title: 'Device Name', sort: true, minWidth: 200 },
                            {
                                field: 'hardware', title: 'Hardware', sort: true, width: 150, templet: function (d) {
                                    return '<span style="color: #718096;">' + (d.hardware || 'UNKNOWN') + '</span>';
                                }
                            },
                            {
                                field: 'status', title: 'Status', sort: true, width: 120, templet: function (d) {
                                    var statusClass = d.status == 'ONLINE' ? 'status-online' : 'status-offline';
                                    return '<span class="status-badge ' + statusClass + '">' + d.status + '</span>';
                                }
                            },
                            { title: 'Actions', align: 'center', toolbar: '#tools', fixed: 'right', width: 300 }
                        ]]
                    });

                    layui.table.on('tool(table1)', function (obj) {
                        var data = obj.data;
                        if (obj.event === 'delete') {
                            vue1.deleteDevice(data.deviceName);
                        }
                    });
                },
                createDevice: function () {
                    layer.open({
                        type: 1,
                        title: 'Create New Device',
                        area: ['400px', '300px'],
                        content: '<div style="padding: 20px;">' +
                            '<form class="layui-form" lay-filter="deviceForm">' +
                            '<div class="layui-form-item">' +
                            '<label class="layui-form-label">Device Name</label>' +
                            '<div class="layui-input-block">' +
                            '<input type="text" name="deviceName" required lay-verify="required" placeholder="Enter device name" class="layui-input">' +
                            '</div>' +
                            '</div>' +
                            '<div class="layui-form-item">' +
                            '<label class="layui-form-label">IMEI</label>' +
                            '<div class="layui-input-block">' +
                            '<input type="text" name="imei" placeholder="Enter IMEI" class="layui-input">' +
                            '</div>' +
                            '</div>' +
                            '<div class="layui-form-item">' +
                            '<div class="layui-input-block">' +
                            '<button class="layui-btn" lay-submit lay-filter="createDevice">Create Device</button>' +
                            '<button type="reset" class="layui-btn layui-btn-primary">Reset</button>' +
                            '</div>' +
                            '</div>' +
                            '</form>' +
                            '</div>',
                        success: function (layero, index) {
                            layui.form.render();
                            layui.form.on('submit(createDevice)', function (data) {
                                var formData = data.field;
                                if (formData.deviceName.length < 3) {
                                    layer.msg('Device name should be at least 3 characters', { anim: 6 });
                                    return false;
                                }
                                $.ajax({
                                    type: 'POST',
                                    url: '${_contextPath}/device/create',
                                    data: formData,
                                    cache: false,
                                    dataType: 'json',
                                    success: function (result) {
                                        if (result.code === 200) {
                                            layer.msg('Device created successfully', { icon: 1 });
                                            layer.close(index);
                                            setTimeout(function () {
                                                window.location.reload();
                                            }, 1000);
                                        } else {
                                            layer.msg(result.msg || 'Failed to create device', { icon: 2 });
                                        }
                                    },
                                    error: function () {
                                        layer.msg('Network error', { icon: 2 });
                                    }
                                });
                                return false;
                            });
                        }
                    });
                },
                deleteDevice: function (deviceName) {
                    layer.confirm('Are you sure you want to delete device: ' + deviceName + '?', {
                        btn: ['Delete', 'Cancel'],
                        icon: 3,
                        title: 'Confirm Delete'
                    }, function (index) {
                        $.ajax({
                            type: 'POST',
                            url: '${_contextPath}/device/delete',
                            data: {
                                deviceName: deviceName
                            },
                            cache: false,
                            dataType: 'json',
                            success: function (result) {
                                if (result.code === 200) {
                                    layer.msg('Device deleted successfully', { icon: 1 });
                                    layer.close(index);
                                    setTimeout(function () {
                                        window.location.reload();
                                    }, 1000);
                                } else {
                                    layer.msg(result.msg || 'Failed to delete device', { icon: 2 });
                                }
                            },
                            error: function () {
                                layer.msg('Network error', { icon: 2 });
                            }
                        });
                    });
                },
                showAdminPanel: function () {
                    layer.open({
                        type: 2,
                        title: 'Admin Management',
                        area: ['80%', '80%'],
                        content: '${_contextPath}/admin/panel'
                    });
                },
                logout: function () {
                    layer.confirm('Are you sure you want to logout?', {
                        btn: ['Logout', 'Cancel'],
                        icon: 3,
                        title: 'Confirm Logout'
                    }, function (index) {
                        // Clear all client-side storage first
                        localStorage.clear();
                        sessionStorage.clear();

                        $.ajax({
                            type: 'POST',
                            url: '${_contextPath}/api/auth/logout',
                            success: function () {
                                // Clear any remaining storage
                                localStorage.clear();
                                sessionStorage.clear();

                                layer.msg('Logged out successfully', { icon: 1 });
                                setTimeout(function () {
                                    // Force redirect to login with cache busting
                                    window.location.replace('${_contextPath}/login?t=' + Date.now());
                                }, 1000);
                            },
                            error: function () {
                                // Even if logout fails, clear storage and redirect
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.replace('${_contextPath}/login?t=' + Date.now());
                            }
                        });
                        layer.close(index);
                    });
                }
            }
        });

        layui.config({ base: '${_contextPath}/web/layuiadmin/' });
        layui.extend({ index: 'lib/index' });
        layui.use(['index', 'form', 'table'], function () {
            vue1.init();
        });
    </script>
</body>

</html>